-- üî´ Weapon lists
local murdererWeapons = {
    ["JS-2 Derringy"] = true, ["JS-22"] = true, ["RR-LCP"] = true,
    ["Sawn-off"] = true, ["Rosen-Obrez"] = true, ["K1911"] = true,
    ["SKORPION"] = true, ["ZZ-90"] = true, ["SILVER STEEL K1911"] = true,
    ["Clothed Rosen-Obrez"] = true, ["Clother Sawn-off"] = true,
    ["Kamatov"] = true, ["GLIDED"] = true,
    ["Charcoal Steel JS-22"] = true, ["Pretty Pink RR-LCP"] = true, ["JS2-BondsDerringy"] = true
}

local sheriffWeapons = {
    ["RR-Snubby"] = true, ["GG-17"] = true, ["J9-M"] = true,
    ["I-412"] = true, ["Silver Steel RR-Snubby"] = true
}

local juggernautWeapons = {
    ["ANKM"] = true,
    ["AT's KAR15"] = true,
    ["RY's GG-17"] = true
}

local innocentWeapons = {
    ["Lead Pipe"] = true, ["Kitchen Knife"] = true, ["Boxcutters"] = true
}

-- üõ† Services
local Players = game:GetService("Players")
local StarterGui = game:GetService("StarterGui")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")

-- üé® Colors
local COLORS = {
    Murderer = Color3.fromRGB(255, 0, 0),
    Sheriff = Color3.fromRGB(0, 0, 255),
    Juggernaut = Color3.fromRGB(255, 165, 0),
    Innocent = Color3.fromRGB(0, 255, 0),
    InnocentWithWeapon = Color3.fromRGB(0, 255, 255)
}

-- üì¶ Role determination
local function determineRole(player)
    local items = {}
    
    -- Check backpack
    local backpack = player:FindFirstChild("Backpack")
    if backpack then
        for _, item in ipairs(backpack:GetChildren()) do
            table.insert(items, item.Name)
        end
    end
    
    -- Check character
    local character = player.Character
    if character then
        for _, item in ipairs(character:GetChildren()) do
            if item:IsA("Tool") then
                table.insert(items, item.Name)
            end
        end
    end
    
    -- Check for special roles first
    for _, item in ipairs(items) do
        if murdererWeapons[item] then return "Murderer" end
        if sheriffWeapons[item] then return "Sheriff" end
        if juggernautWeapons[item] then return "Juggernaut" end
    end
    
    -- Check for armed innocents
    for _, item in ipairs(items) do
        if innocentWeapons[item] then return "InnocentWithWeapon", item end
    end
    
    return "Innocent"
end

-- ‚ú® Player highlighting
local function highlightPlayer(player, role)
    local character = player.Character
    if not character then return end
    
    -- Remove existing highlight
    local existing = character:FindFirstChild("RoleHighlight")
    if existing then existing:Destroy() end
    
    -- Create new highlight
    local highlight = Instance.new("Highlight")
    highlight.Name = "RoleHighlight"
    highlight.FillTransparency = 0.7
    highlight.OutlineTransparency = 0.3
    highlight.FillColor = COLORS[role] or COLORS.Innocent
    highlight.OutlineColor = Color3.new(0, 0, 0)
    highlight.Parent = character
end

-- üè∑ Name tags
local function createNameTag(player, role, weapon)
    local character = player.Character
    if not character then return end
    
    local head = character:FindFirstChild("Head")
    if not head then return end
    
    -- Remove old tag
    local oldTag = head:FindFirstChild("RoleTag")
    if oldTag then oldTag:Destroy() end
    
    -- Create new tag
    local billboard = Instance.new("BillboardGui")
    billboard.Name = "RoleTag"
    billboard.Size = UDim2.new(0, 200, 0, 50)
    billboard.StudsOffset = Vector3.new(0, 3, 0)
    billboard.AlwaysOnTop = true
    billboard.Adornee = head
    billboard.MaxDistance = 100
    billboard.Active = true
    
    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1, 0, 1, 0)
    label.BackgroundTransparency = 1
    label.Font = Enum.Font.SourceSansBold
    label.TextSize = 18
    label.TextStrokeTransparency = 0.5
    label.TextColor3 = COLORS[role] or COLORS.Innocent
    
    if role == "InnocentWithWeapon" then
        label.Text = string.format("%s\n(‚öî %s)", player.Name, weapon)
    elseif role == "Innocent" then
        label.Text = player.Name
    else
        label.Text = string.format("%s: %s", role:upper(), player.Name)
    end
    
    label.Parent = billboard
    billboard.Parent = head
end

-- üßπ Cleanup on death
local function cleanupCharacter(character)
    if not character then return end
    
    local highlight = character:FindFirstChild("RoleHighlight")
    if highlight then highlight:Destroy() end
    
    local head = character:FindFirstChild("Head")
    if head then
        local tag = head:FindFirstChild("RoleTag")
        if tag then tag:Destroy() end
    end
end

-- üìä Stats UI
local function setupStatsUI()
    local playerGui = Players.LocalPlayer:WaitForChild("PlayerGui")
    
    -- Remove old UI
    local oldUI = playerGui:FindFirstChild("RoleStatsUI")
    if oldUI then oldUI:Destroy() end
    
    -- Create container
    local container = Instance.new("ScreenGui")
    container.Name = "RoleStatsUI"
    container.ResetOnSpawn = false
    container.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(0, 250, 0, 180)
    frame.Position = UDim2.new(1, -260, 0, 10)
    frame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    frame.BackgroundTransparency = 0.3
    frame.BorderSizePixel = 0
    
    local statsLabel = Instance.new("TextLabel")
    statsLabel.Size = UDim2.new(1, -10, 1, -40)
    statsLabel.Position = UDim2.new(0, 5, 0, 5)
    statsLabel.BackgroundTransparency = 1
    statsLabel.TextXAlignment = Enum.TextXAlignment.Left
    statsLabel.TextYAlignment = Enum.TextYAlignment.Top
    statsLabel.Font = Enum.Font.SourceSansBold
    statsLabel.TextSize = 18
    statsLabel.TextColor3 = Color3.new(1, 1, 1)
    statsLabel.Text = "Loading stats..."
    statsLabel.Name = "StatsLabel"
    
    local footer = Instance.new("TextLabel")
    footer.Size = UDim2.new(1, -10, 0, 30)
    footer.Position = UDim2.new(0, 5, 1, -35)
    footer.BackgroundTransparency = 1
    footer.Font = Enum.Font.SourceSans
    footer.TextSize = 16
    footer.Text = "BloodDebt ESP v1.2"
    footer.TextColor3 = Color3.new(1, 1, 1)
    
    statsLabel.Parent = frame
    footer.Parent = frame
    frame.Parent = container
    container.Parent = playerGui
    
    return statsLabel
end

-- üîÑ Update all players
local function updateAllPlayers(statsLabel)
    local counts = {
        Murderer = 0,
        Sheriff = 0,
        Juggernaut = 0,
        Innocent = 0,
        InnocentWithWeapon = 0
    }
    
    for _, player in ipairs(Players:GetPlayers()) do
        local role, weapon = determineRole(player)
        counts[role] = counts[role] + 1
        
        if player.Character then
            highlightPlayer(player, role)
            createNameTag(player, role, weapon)
        end
    end
    
    if statsLabel then
        statsLabel.Text = string.format(
            "üî¥ Murderers: %d\nüîµ Sheriffs: %d\nüü† Juggernauts: %d\n‚öî Armed: %d\nüë§ Total: %d",
            counts.Murderer, counts.Sheriff, counts.Juggernaut, 
            counts.InnocentWithWeapon,
            #Players:GetPlayers()
        )
    end
end

-- üèÅ Initialize
local statsLabel = setupStatsUI()

-- Process existing players
for _, player in ipairs(Players:GetPlayers()) do
    player.CharacterAdded:Connect(function(character)
        task.wait(1) -- Wait for character to fully load
        local role, weapon = determineRole(player)
        highlightPlayer(player, role)
        createNameTag(player, role, weapon)
        
        character:WaitForChild("Humanoid").Died:Connect(function()
            cleanupCharacter(character)
        end)
    end)
    
    if player.Character then
        task.spawn(function()
            task.wait(1)
            local role, weapon = determineRole(player)
            highlightPlayer(player, role)
            createNameTag(player, role, weapon)
        end)
    end
end

-- Handle new players
Players.PlayerAdded:Connect(function(player)
    player.CharacterAdded:Connect(function(character)
        task.wait(1)
        local role, weapon = determineRole(player)
        highlightPlayer(player, role)
        createNameTag(player, role, weapon)
        
        character:WaitForChild("Humanoid").Died:Connect(function()
            cleanupCharacter(character)
        end)
    end)
end)

-- Update loop
RunService.Heartbeat:Connect(function()
    updateAllPlayers(statsLabel)
end)

-- Initial update
updateAllPlayers(statsLabel)

-- Notification
StarterGui:SetCore("SendNotification", {
    Title = "BloodDebt ESP",
    Text = "Successfully loaded!",
    Duration = 5,
    Icon = "rbxassetid://6726575885"
})
